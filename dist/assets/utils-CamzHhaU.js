async function t(t,e,o){return new Promise((n,r)=>{const a=new Image;a.crossOrigin="anonymous",a.onload=()=>{try{let t=a.width,i=a.height;t>i?t>e&&(i*=e/t,t=e):i>o&&(t*=o/i,i=o);const h=document.createElement("canvas"),c=h.getContext("2d");if(!c)return void r(new Error("Failed to get canvas context for resizing"));h.width=t,h.height=i,c.drawImage(a,0,0,t,i),n(h.toDataURL("image/png"))}catch(t){r(t)}},a.onerror=t=>{r(new Error("Failed to load image for resizing"))},a.src=t})}const e={maxBackgroundColorDiff:80};function o(t,e,o,n,r,a){return Math.sqrt(Math.pow(t-n,2)+Math.pow(e-r,2)+Math.pow(o-a,2))}async function n(t,n=e){return new Promise((r,a)=>{const i=new Image;let h;t.startsWith("data:")||(i.crossOrigin="anonymous"),h=setTimeout(()=>{a(new Error("Background removal timed out after 30 seconds"))},3e4),i.onload=()=>{clearTimeout(h);try{let t=function(t,e){const n=[{x:t,y:e}];for(;n.length>0&&n.length<1e5;){const{x:t,y:e}=n.pop();if(t<0||t>=h.width||e<0||e>=h.height)continue;const r=e*h.width+t;if(f[r])continue;const a=4*r,i=u[a],c=u[a+1],g=u[a+2];if(u[a+3]<10){f[r]=1;continue}o(i,c,g,m.r,m.g,m.b)<=w&&(f[r]=1,n.push({x:t-1,y:e}),n.push({x:t+1,y:e}),n.push({x:t,y:e-1}),n.push({x:t,y:e+1}))}};const h=document.createElement("canvas"),c=h.getContext("2d",{willReadFrequently:!0});if(!c)return void a(new Error("Failed to get canvas context"));const g=2e3;let d=i.width,s=i.height;if(d>g||s>g){const t=Math.min(g/d,g/s);d=Math.floor(d*t),s=Math.floor(s*t)}h.width=d,h.height=s,c.imageSmoothingEnabled=!0,c.imageSmoothingQuality="high",c.drawImage(i,0,0,d,s);const l=c.getImageData(0,0,h.width,h.height),u=l.data,m=function(t){const e=t.data,o=t.width,n=t.height,r=[];return[0,4*o-4,o*(n-1)*4,o*n*4-4,2*o*4,o*(n-1)*4+2*o*4,2*n*4,4*(2*n+o-1)].forEach(t=>{t>=0&&t<e.length&&r.push({r:e[t],g:e[t+1],b:e[t+2]})}),0===r.length?{r:255,g:255,b:255}:{r:Math.round(r.reduce((t,e)=>t+e.r,0)/r.length),g:Math.round(r.reduce((t,e)=>t+e.g,0)/r.length),b:Math.round(r.reduce((t,e)=>t+e.b,0)/r.length)}}(l),{maxBackgroundColorDiff:w}={...e,...n},f=new Uint8Array(h.width*h.height);[{x:0,y:0},{x:h.width-1,y:0},{x:0,y:h.height-1},{x:h.width-1,y:h.height-1},{x:Math.floor(h.width/2),y:0},{x:Math.floor(h.width/2),y:h.height-1},{x:0,y:Math.floor(h.height/2)},{x:h.width-1,y:Math.floor(h.height/2)}].forEach(e=>{t(e.x,e.y)});for(let e=0;e<f.length;e++)if(1===f[e]){const t=4*e;u[t]=255,u[t+1]=255,u[t+2]=255,u[t+3]=255}c.putImageData(l,0,0);const y=h.toDataURL("image/png",.95);h.width=1,h.height=1,r(y)}catch(t){a(t instanceof Error?t:new Error("Unknown background removal error"))}},i.onerror=t=>{clearTimeout(h),a(new Error("Failed to load image for background removal. Please check if the image is valid."))},i.src=t})}export{t as a,n as r};
